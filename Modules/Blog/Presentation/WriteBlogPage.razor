@page "/new-blog"
@using System.Reactive.Linq
@using System.Reactive.Subjects
@using System.Security.Claims
@inject IUploadProvider UploadProvider
@rendermode InteractiveServer
@using HiHoHuBlog.Components.Components
@using HiHoHuBlog.Modules.Blog.Entity
@using HiHoHuBlog.Modules.Blog.Presentation.Components.TextEditor
@using HiHoHuBlog.Modules.Blog.Service.Interface
@using HiHoHuBlog.Modules.User.Entity
@using HiHoHuBlog.Utils
@using Toolbar = HiHoHuBlog.Modules.Blog.Presentation.Components.TextEditor.Toolbar
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Logging.Console
@inject NavigationManager NavigationManager
@inject ICreateBlogService CreateBlogService
@inject IBlogUpdateService BlogUpdateService
@inject IToastService ToastService


@attribute [Authorize]
<AuthorizeView Roles="admin, user">
<Authorized>
<div class="h-screen ">
    <Container ContainerClass="pb-80">
        <div class="flex flex-row-reverse pt-2">
            <button @onclick="OnPublish" class="btn btn-success @(_blog.Id == 0 ? "btn-disabled" : " ") text-base-200 btn-sm ">Publish</button>
        </div>
        <div class="flex justify-between pt-5 ">
            <input @oninput="OnSearchQueryInput" placeholder="title" class="text-4xl w-full input focus:ring-0 border-transparent focus:border-transparent px-0 !outline-none"/>
        </div>
        @if (_firstChange)
        {
            <div class="py-2">
                @if (_isSaving)
                {
                    <div class="flex align-middle text-gray-500 space-x-2">
                        <span class="loading loading-spinner loading-md"></span>
                        <span class="">saving...</span>
                    </div>
                }
                else
                {
                    <div class="flex align-middle text-gray-500 space-x-2">
                        <span class="">Saved</span>
                    </div>
                }
            </div>
        }
        <div class="h-full">
            <TextEditor ImageUploadFunc="OnUpload" OnChange="OnChange" Toolbar="new Toolbar { ShowFullToolbar = true }" EditorContainerId="TestId" @ref="@TextEditor"
                        Placeholder="Write your own words...">
            </TextEditor>
        </div>


    </Container>
</div>
    </Authorized>
</AuthorizeView>

@code {
    TextEditor TextEditor;
    [CascadingParameter] 
    Task<AuthenticationState> authenticationStateTask { get; set; }

    private IDisposable? _titleSubscription;
    private readonly Subject<string?> _titleSubject = new();
    
    private IDisposable? _contentSubscription;
    private readonly Subject<string?> _contentSubject = new();
    private bool _firstImage = false;    
    private  void OnChange(string args)
    {
        _isSaving = true;
        var content = args;
        _contentSubject.OnNext(content);
        _isSaving = false;
    }

    private async Task<Result<string, Err>> OnUpload(string name, string type, string array)
    {
         
        // Validate file type
        if (!type.StartsWith("image/"))
        {
            return Result<string, Err>.Err(new Err("Only image files are allowed"));
        }

        // Remove data:image/...;base64, prefix if present
        var base64Data = array;
        if (base64Data.Contains(","))
        {
            base64Data = base64Data.Substring(base64Data.IndexOf(",") + 1);
        }

        // Convert base64 to bytes
        byte[] fileData = Convert.FromBase64String(base64Data);

        // Generate unique filename with original extension
        string extension = Path.GetExtension(name);
        string newFileName = $"{Guid.NewGuid()}{extension}";
        
        var uR = await UploadProvider.UploadImage(fileData, newFileName);
        if (!uR.IsOk)
        {
            return Result<string, Err>.Err(uR.Error);
        }
        
        // Return the URL path
        if (!_firstImage)
        {
            _firstImage = true;
        }
        
        return Result<string,Err>.Ok(uR.Value.Url);
    } 
    
    private bool _isSaving = false;
    private readonly BlogCreate _blog = new BlogCreate();

    
    private IRequester _requester;
    private bool _firstChange = false;

    
    private  void OnSearchQueryInput(ChangeEventArgs args)
    {
            _isSaving = true;
            var title = args.Value?.ToString();
            _titleSubject.OnNext(title?.Trim());
            _isSaving = false;
    }

    protected override async Task OnInitializedAsync()
    {
        _requester = await AuthUtils.GetInfo(authenticationStateTask); 
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        _contentSubscription = _contentSubject
            .Throttle(TimeSpan.FromMilliseconds(1500))
            .Subscribe(async content =>
            {
                await InvokeAsync(async () =>
                {
                    _isSaving = true;
                    StateHasChanged();
                    _blog.Content = content;
                    if (!_firstChange)
                    {
                        _firstChange = true;
                        await CreateBlogService.CreateNewBlog(_requester, _blog);
                    }
                    else
                    {
                        var r = await BlogUpdateService.UpdateContent(_requester, _blog.Id, content);
                    }
                    _isSaving = false;
                    StateHasChanged();
                });
            });
        
        _titleSubscription = _titleSubject
            .Throttle(TimeSpan.FromMilliseconds(300))
            .Subscribe(async title =>
            {
                await InvokeAsync(async () =>
                {
                    _isSaving = true;
                    StateHasChanged();
                    _blog.Title = title;
                    if (!_firstChange)
                    {
                        _firstChange = true;
                        await CreateBlogService.CreateNewBlog(_requester, _blog);
                    }
                    else
                    {
                        var r = await BlogUpdateService.UpdateTitle(_requester, _blog.Id, title);
                    }
                    _isSaving = false;
                    StateHasChanged();
                });

            });
    }

    public async void OnPublish()
    {
        var r = await BlogUpdateService.Publish(_requester, _blog.Id, _blog.Content);
        if (!r.IsOk)
        {
            ToastService.ShowError(r.Error.Message);
            return;
        }
        ToastService.ShowSuccess("Publish success!");
    }
    
    
    public void Dispose()
    {
        _titleSubscription?.Dispose();
        _contentSubscription?.Dispose();
    }

    private async void Callback(ChangeEventArgs obj)
    {
        Console.WriteLine(await TextEditor.GetHTML());
    }

}